function getState(e){return layerStates.has(e)||layerStates.set(e,{scene:null,camera:null,renderer:null,model:null,ambientLight:null,directionalLight:null,fillLight:null,customNormalMap:null,customEnvMap:null,envMap:null,customColorMap:null}),layerStates.get(e)}function convertToPBR(e){const a=new THREE.MeshStandardMaterial;return a.color.copy(e.color),a.map=e.map,a.normalMap=e.normalMap,a.emissiveMap=e.emissiveMap,a.aoMap=e.aoMap,a.emissive.copy(e.emissive||new THREE.Color(0,0,0)),a.opacity=e.opacity??1,a.transparent=e.transparent??!1,a.side=e.side??THREE.FrontSide,e.userData||(e.userData={}),a.userData=e.userData,a.userData.converted=!0,a}function applyQualitySettings(e,a){e.renderer&&(e.renderer.toneMapping=a?THREE.ACESFilmicToneMapping:THREE.NoToneMapping,e.renderer.toneMappingExposure=a?1.5:1,e.renderer.physicallyCorrectLights=a)}function loadTextureWithSettings(e,a=!1,t=!1){return new Promise(t=>{textureLoader.load(e,e=>{a?(e.mapping=THREE.EquirectangularReflectionMapping,e.colorSpace=THREE.SRGBColorSpace,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.generateMipmaps=!1):(e.wrapS=e.wrapT=THREE.RepeatWrapping,e.flipY=!0),t(e)})})}function applyTextureToMaterials(e,a,t,r,o="map",l=1,n=1){a.repeat.setScalar(t);const i=-(t-1)/2,s=((null==r?void 0:r.x)??.5)-.5,p=((null==r?void 0:r.y)??.5)-.5;a.offset.set(i+s,i+p),e.model.traverse(e=>{e.isMesh&&(Array.isArray(e.material)?e.material:[e.material]).forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhongMaterial||e.isMeshLambertMaterial)&&("map"===o?(e.map=a,e.color&&e.color.setScalar(n)):"normalMap"===o&&void 0!==e.normalMap&&(e.normalMap=a,e.normalScale&&e.normalScale.set(l,-l)),e.needsUpdate=!0)})})}function applyEnvMapToMaterials(e,a,t){var r;a&&e.model&&(null==(r=e.model.userData.materials)||r.forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(e.envMap=a,e.envMapIntensity=t,e.needsUpdate=!0)}))}function createSVGMeshes(e,a,t){const r=new THREE.Group;for(let o=0;o<e.length;o++){const l=e[o],n=l.userData.style.fill;if(void 0!==n&&"none"!==n){const e=new THREE.MeshStandardMaterial({color:(new THREE.Color).setStyle(n),metalness:t.getProp("materialMetalness")??.5,roughness:t.getProp("materialRoughness")??.5,side:THREE.DoubleSide}),o=SVGLoader.createShapes(l);for(let t=0;t<o.length;t++){const l=o[t],n=new THREE.ExtrudeGeometry(l,a),i=n.attributes.position,s=n.attributes.uv;n.computeBoundingBox();const p=n.boundingBox.min,m=n.boundingBox.max,d=m.x-p.x,c=m.y-p.y,u=(e,a,t)=>{for(let r=e;e+a>r;r++){let e=r;if(n.index&&(e=n.index.getX(r)),t){const a=s.getX(e),t=s.getY(e),r=1/Math.max(d,c);s.setXY(e,a*r,t*r)}else{const a=i.getX(e),t=i.getY(e);s.setXY(e,(a-p.x)/d,(t-p.y)/c)}}};n.groups&&n.groups.length>0?n.groups.forEach(e=>{u(e.start,e.count,1===e.materialIndex)}):u(0,n.index?n.index.count:i.count,!1),s.needsUpdate=!0;const g=new THREE.Mesh(n,e);g.scale.set(1,-1,1),r.add(g)}}}return r}function updateEnvMapFromWebGL(e,a,t,r,o,l){var n,i,s;if(t&&a)if(e.envMap)e.model.userData.lastEnvMapIntensity!==l&&(null==(s=e.model.userData.materials)||s.forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(e.envMapIntensity=l)}),e.model.userData.lastEnvMapIntensity=l);else{e.envMap=new THREE.Texture,e.envMap.mapping=THREE.EquirectangularReflectionMapping,e.envMap.colorSpace=THREE.SRGBColorSpace,e.envMap.minFilter=THREE.LinearFilter,e.envMap.magFilter=THREE.LinearFilter,e.envMap.generateMipmaps=!1,e.envMap.flipY=!1,e.envMap.image={width:r,height:o};const a=e.renderer.properties.get(e.envMap);a.__webglTexture=t,a.__webglInit=!0;const n=e.renderer.info.memory;n&&n.textures++,applyEnvMapToMaterials(e,e.envMap,l)}else null==(i=null==(n=e.model)?void 0:n.userData.materials)||i.forEach(e=>{e.envMap&&(e.envMap=null,e.needsUpdate=!0)})}function initialize(e,a){const t=getState(a),r=e.canvas?e.canvas.width:e.drawingBufferWidth,o=e.canvas?e.canvas.height:e.drawingBufferHeight;if(0===r||0===o)return;t.scene=new THREE.Scene,t.camera=new THREE.PerspectiveCamera(35,r/o,.1,100),t.camera.position.set(0,0,5),t.renderer=new THREE.WebGLRenderer({canvas:e.canvas,context:e,alpha:!0,preserveDrawingBuffer:!1,premultipliedAlpha:!0,logarithmicDepthBuffer:!0,antialias:"high"===a.quality}),t.renderer.setClearColor(0,0),t.renderer.outputColorSpace=THREE.SRGBColorSpace,applyQualitySettings(t,"high"===a.quality),t.renderer.setPixelRatio(1),t.renderer.setSize(r,o,!1);const l=a.getProp("ambientLightColor"),n=a.getProp("ambientLightIntensity"),i=a.getProp("lightColor"),s=a.getProp("lightIntensity"),p=a.getProp("fillLightColor"),m=a.getProp("fillLightIntensity"),d=a.getProp("lightPosition");t.ambientLight=new THREE.AmbientLight(l||"#777777",2*(n??.75)),t.scene.add(t.ambientLight),t.directionalLight=new THREE.DirectionalLight(i||"#777777",5*(s??.2)*2),t.scene.add(t.directionalLight),t.fillLight=new THREE.DirectionalLight(p||"#777777",5*(m??.2)*2),t.scene.add(t.fillLight);const c=10*(d.x-.5),u=10*(d.y-.5),g=10*(d.z-.5);t.directionalLight&&t.directionalLight.position.set(c,-u,g),t.fillLight&&t.fillLight.position.set(.8*-c,.8*u,.8*-g)}function loadModel(e){const a=getState(e);e.local.modelLoaded=!1,e.local.modelLoading=!1;const t=e.modelUrl.toLowerCase(),r=t.startsWith("data:image/svg+xml");if(t.split("?")[0].endsWith(".svg")||r){const t=t=>{var r,o;const l=t.paths,n=createSVGMeshes(l,{depth:e.getProp("extrudeDepth")??10,bevelEnabled:e.getProp("bevelEnabled")??!1,bevelThickness:e.getProp("bevelThickness")??1,bevelSize:e.getProp("bevelSize")??1,bevelSegments:e.getProp("bevelSegments")??2},e);a.model=n,a.model.userData.isSVG=!0,a.model.userData.svgPaths=l;const i=(new THREE.Box3).setFromObject(a.model),s=i.getCenter(new THREE.Vector3);a.model.position.copy(s).multiplyScalar(-1);const p=i.getSize(new THREE.Vector3),m=Math.max(p.x,p.y,p.z),d=m>0?1/m:1,c=new THREE.Group;c.add(a.model),a.model=c,a.model.userData.baseScale=d,a.model.userData.isSVGWrapper=!0,a.model.userData.materials=[],a.model.userData.textureMaterials=[],a.model.userData.meshes=[],a.model.traverse(e=>{e.isMesh&&(a.model.userData.meshes.push(e),a.model.userData.materials.push(e.material),a.model.userData.textureMaterials.push(e.material),e.material.userData||(e.material.userData={}),e.material.userData.originalMap=null,e.material.userData.originalNormalMap=null)}),e.renderNormals&&a.model.userData.meshes&&a.model.userData.meshes.forEach(e=>{e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=normalsMaterial)}),(null==(r=e.colorMapUrl)?void 0:r.trim())&&!e.renderNormals&&loadTextureWithSettings(e.colorMapUrl,!1).then(t=>{const r=Math.max(.001,e.getProp("colorMapScale")??1),o=e.getProp("colorMapIntensity")??1;applyTextureToMaterials(a,t,r,e.getProp("colorMapPosition"),"map",1,o),a.customColorMap=t}),(null==(o=e.normalMapUrl)?void 0:o.trim())&&!e.renderNormals&&loadTextureWithSettings(e.normalMapUrl,!1,!0).then(t=>{const r=Math.max(.001,e.getProp("normalMapScale")??1);applyTextureToMaterials(a,t,r,e.getProp("normalMapPosition"),"normalMap",e.getProp("normalMapIntensity")),a.customNormalMap=t}),a.customEnvMap&&e.environmentMapIntensity>0&&applyEnvMapToMaterials(a,a.customEnvMap,e.environmentMapIntensity),a.scene.add(a.model),e.handleModelLoaded()};if(r)try{const a=e.modelUrl.split(",")[1],r=decodeURIComponent(escape(atob(a)));t(svgLoader.parse(r))}catch(a){console.error("An error occurred while parsing the SVG data URL:",a),e.local.modelLoading=!1}else svgLoader.load(e.modelUrl,t,e=>{e.total>0&&console.log(e.loaded/e.total*100+"% loaded")},a=>{console.error("An error occurred while loading the SVG:",a),e.local.modelLoading=!1})}else gltfLoader.load(e.modelUrl,t=>{var r;a.model=t.scene;const o=(new THREE.Box3).setFromObject(a.model),l=o.getCenter(new THREE.Vector3);a.model.position.copy(l).multiplyScalar(-1);const n=o.getSize(new THREE.Vector3),i=Math.max(n.x,n.y,n.z),s=i>0?1/i:1,p=new THREE.Group;p.add(a.model),a.model=p,a.model.userData.baseScale=s,a.model.userData.materials=[],a.model.traverse(t=>{if(t.isMesh){const r=Array.isArray(t.material)?t.material:[t.material],o=e.getProp("materialMetalness"),l=e.getProp("materialRoughness");r.forEach((e,r)=>{var n;if((e.isMeshPhongMaterial||e.isMeshLambertMaterial)&&!(null==(n=e.userData)?void 0:n.converted)){const a=convertToPBR(e);Array.isArray(t.material)?t.material[r]=a:t.material=a,e=a}a.model.userData.materials.push(e),void 0!==e.metalness&&(e.metalnessMap&&(e.metalnessMap=null,e.needsUpdate=!0),e.metalness=o??e.metalness),void 0!==e.roughness&&(e.roughnessMap&&(e.roughnessMap=null,e.needsUpdate=!0),e.roughness=l??e.roughness),(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(e.envMapIntensity=e.envMapIntensity??1)}),e.renderNormals&&(t.material=normalsMaterial)}}),e.colorMapUrl&&!e.renderNormals&&(a.model.traverse(e=>{e.isMesh&&(Array.isArray(e.material)?e.material:[e.material]).forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhongMaterial||e.isMeshLambertMaterial)&&(e.map=null,e.needsUpdate=!0)})}),loadTextureWithSettings(e.colorMapUrl,!1).then(t=>{a.customColorMap=t;const r=e.getProp("colorMapIntensity")??1;applyTextureToMaterials(a,t,Math.max(.001,e.getProp("colorMapScale")),e.getProp("colorMapPosition"),"map",1,r)})),e.normalMapUrl&&!e.renderNormals&&loadTextureWithSettings(e.normalMapUrl,!1,!0).then(t=>{a.customNormalMap=t,applyTextureToMaterials(a,t,Math.max(.001,e.getProp("normalMapScale")),e.getProp("normalMapPosition"),"normalMap",e.getProp("normalMapIntensity"))});const m=e.getProp("environmentMapIntensity");m>0&&(null==(r=e.environmentMapUrl)?void 0:r.trim())&&loadTextureWithSettings(e.environmentMapUrl,!0).then(e=>{a.customEnvMap=e,applyEnvMapToMaterials(a,a.customEnvMap,m)}),a.scene.add(a.model),e.handleModelLoaded()},void 0,e=>{console.error("An error occurred while loading the model:",e)});e.local.modelLoading=!0}function isLoading(e){return e.local.modelLoading&&!e.local.modelLoaded}function draw(e,a,t){var r,o,l,n,i;const s=getState(t);if(!t.local.modelLoaded)return;if(!s.renderer||!s.renderer.getContext()||s.renderer.getContext().isContextLost())return console.warn("Three.js renderer context lost, reinitializing..."),void(t.local.initialized=!1);const p=e.canvas?e.canvas.width:e.drawingBufferWidth,m=e.canvas?e.canvas.height:e.drawingBufferHeight;if(0===p||0===m)return;const d=t.getProp("environmentMapIntensity");if(d>0&&!(null==(r=t.environmentMapUrl)?void 0:r.trim())){const e=t.local.envTexture,a=(null==(o=s.model)?void 0:o.userData.lastEnvMapIntensity)!==d;!e||!a&&s.envMap||updateEnvMapFromWebGL(s,e.gl,e.webglTexture,e.width,e.height,d)}let c=0,u=0,g=0,M=0,h=0,v=0;const E=t.getProp("trackMouse"),y=t.getProp("rotationTracking"),f=t.getProp("lightTracking");if(0!=E||0!=y||0!=f){const e=t.local.mouse||{x:.5,y:.5},a=e.x-.5,r=e.y-.5;0!=E&&(c=a*E,u=-r*E),0!=y&&(g=-r*y,M=-a*y),0!=f&&(h=a*f,v=-r*f)}s.camera.userData.dim||(s.camera.userData.dim={}),s.camera.userData.dim.w===p&&s.camera.userData.dim.h===m||(s.camera.aspect=p/m,s.camera.updateProjectionMatrix(),s.renderer.setSize(p,m,!1),s.camera.userData.dim={w:p,h:m});const x=s.scene.userData.lp=s.scene.userData.lp||{},S=t.getProp("ambientLightIntensity"),L=t.getProp("ambientLightColor"),P=t.getProp("lightIntensity"),T=t.getProp("lightColor"),R=t.getProp("fillLightIntensity"),D=t.getProp("fillLightColor");!s.ambientLight||x.ai===S&&x.ac===L||(x.ai!==S&&(s.ambientLight.intensity=2*(S??.75)),x.ac!==L&&s.ambientLight.color.set(L||"#777777"),x.ai=S,x.ac=L),!s.directionalLight||x.li===P&&x.lc===T||(s.directionalLight.intensity=5*(P??.2)*2,s.directionalLight.color.set(T||"#777777"),x.li=P,x.lc=T),!s.fillLight||x.fli===R&&x.flc===D||(s.fillLight.intensity=5*(R??.2)*2,s.fillLight.color.set(D||"#777777"),x.fli=R,x.flc=D);const w=t.getProp("lightPosition"),b=0!=f;if(s.directionalLight&&w&&(b||x.lx!==w.x||x.ly!==w.y||x.lz!==w.z)){const e=10*(w.x+h-.5),a=10*(w.y+v-.5),t=10*(w.z-.5);s.directionalLight.position.set(e,-a,t),s.fillLight.position.set(.8*-e,.8*a,.8*-t),b||(x.lx=w.x,x.ly=w.y,x.lz=w.z)}if(s.model){const e=s.model.userData.mp=s.model.userData.mp||{},r=t.getProp("materialMetalness"),o=t.getProp("materialRoughness");e.mm===r&&e.mr===o||(null==(l=s.model.userData.materials)||l.forEach(a=>{e.mm!==r&&void 0!==a.metalness&&(a.metalnessMap&&(a.metalnessMap=null,a.needsUpdate=!0),a.metalness=r),e.mr!==o&&void 0!==a.roughness&&(a.roughnessMap&&(a.roughnessMap=null,a.needsUpdate=!0),a.roughness=o)}),e.mm=r,e.mr=o);const p=t.getProp("colorMapScale"),m=t.getProp("colorMapPosition"),h=t.getProp("colorMapIntensity");if(s.customColorMap&&!t.renderNormals&&(e.cms!==p||e.cmpx!==(null==m?void 0:m.x)||e.cmpy!==(null==m?void 0:m.y)||e.cmi!==h)){const a=Math.max(.001,p);s.customColorMap.repeat.setScalar(a);const t=-(a-1)/2,r=((null==m?void 0:m.x)??.5)-.5,o=((null==m?void 0:m.y)??.5)-.5;s.customColorMap.offset.set(t+r,t+o);const l=h??1;null==(n=s.model.userData.materials)||n.forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhongMaterial||e.isMeshLambertMaterial)&&(e.color&&e.color.setScalar(l),e.needsUpdate=!0)}),e.cms=p,e.cmpx=null==m?void 0:m.x,e.cmpy=null==m?void 0:m.y,e.cmi=h}const v=t.getProp("normalMapScale"),E=t.getProp("normalMapPosition"),y=t.getProp("normalMapIntensity");if(s.customNormalMap&&!t.renderNormals&&(e.nms!==v||e.nmpx!==(null==E?void 0:E.x)||e.nmpy!==(null==E?void 0:E.y)||e.nmi!==y)){const a=Math.max(.001,v);s.customNormalMap.repeat.setScalar(a);const t=-(a-1)/2,r=((null==E?void 0:E.x)??.5)-.5,o=((null==E?void 0:E.y)??.5)-.5;s.customNormalMap.offset.set(t+r,t+o);const l=y??1;null==(i=s.model.userData.materials)||i.forEach(e=>{void 0!==e.normalMap&&e.normalScale&&(e.normalScale.set(l,-l),e.needsUpdate=!0)}),e.nms=v,e.nmpx=null==E?void 0:E.x,e.nmpy=null==E?void 0:E.y,e.nmi=y}s.customEnvMap&&e.emi!==d&&(applyEnvMapToMaterials(s,s.customEnvMap,d),e.emi=d);const f=s.model.userData.baseScale||1,x=t.getProp("pos"),S=t.getProp("scale");if(e.s!==S){const a=10*S*f;s.model.scale.set(a,a,a),e.s=S}const L=0!==c||0!==u;if(x&&(L||e.px!==x.x||e.py!==x.y||e.pz!==x.z)){const a=8*(x.x-.5+c),t=8*(x.y-.5+u),r=8*(x.z-.5);s.model.position.set(a,-t,r),L||(e.px=x.x,e.py=x.y,e.pz=x.z)}const P=t.getProp("modelRotation"),T=t.getProp("speed"),R=t.getProp("animationAxis"),D=0!==g||0!==M,w=T>0&&t.animating;if(P&&(D||w||e.rx!==P.x||e.ry!==P.y||e.rz!==P.z)){let t=(P.y-.5+g)*Math.PI*2+Math.PI,r=s.model.userData.isSVGWrapper?Math.PI:0,o=(P.x-.5+M)*Math.PI*2+r,l=(P.z-.5)*Math.PI*2;if(w){const e=T*a*.001;R.x>0&&(t+=e*R.x),R.y>0&&(o+=e*R.y),R.z>0&&(l+=e*R.z)}s.model.rotation.set(t,o,l),D||w||(e.rx=P.x,e.ry=P.y,e.rz=P.z)}}s.renderer.render(s.scene,s.camera),s.renderer.resetState&&s.renderer.resetState()}function dispose(e){const a=getState(e);a.customColorMap&&(a.customColorMap.dispose(),a.customColorMap=null),a.customNormalMap&&(a.customNormalMap.dispose(),a.customNormalMap=null),a.customEnvMap&&(a.customEnvMap.dispose(),a.customEnvMap=null),a.envMap&&(a.envMap.dispose(),a.envMap=null),a.model&&(a.model.traverse(e=>{e.isMesh&&(e.geometry&&e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material&&e.material.dispose())}),a.scene&&a.scene.remove(a.model),a.model=null),a.renderer&&(a.renderer.dispose(),a.renderer=null),a.scene=null,a.camera=null,a.ambientLight=null,a.directionalLight=null,a.fillLight=null,layerStates.delete(e)}import{GLTFLoader,SVGLoader,THREE}from"./three-bundle.js";const gltfLoader=new GLTFLoader,svgLoader=new SVGLoader,textureLoader=new THREE.TextureLoader,normalsMaterial=new THREE.MeshNormalMaterial,layerStates=new WeakMap;