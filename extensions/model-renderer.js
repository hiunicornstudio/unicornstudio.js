import{GLTFLoader,SVGLoader,THREE}from"./three-bundle.js";const e=new GLTFLoader,a=new SVGLoader,t=new THREE.TextureLoader,r=new THREE.MeshNormalMaterial,o=new WeakMap;function n(e){return o.has(e)||o.set(e,{scene:null,camera:null,renderer:null,model:null,ambientLight:null,directionalLight:null,fillLight:null,customNormalMap:null,customEnvMap:null,envMap:null,customColorMap:null}),o.get(e)}function l(e,a=!1,r=!1){return new Promise(r=>{t.load(e,e=>{a?(e.mapping=THREE.EquirectangularReflectionMapping,e.colorSpace=THREE.SRGBColorSpace,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.generateMipmaps=!1):(e.wrapS=e.wrapT=THREE.RepeatWrapping,e.flipY=!0),r(e)})})}function i(e,a,t,r,o="map",n=1,l=1){a.repeat.setScalar(t);const i=-(t-1)/2,s=((null==r?void 0:r.x)??.5)-.5,m=((null==r?void 0:r.y)??.5)-.5;a.offset.set(i+s,i+m),e.model.traverse(e=>{e.isMesh&&(Array.isArray(e.material)?e.material:[e.material]).forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhongMaterial||e.isMeshLambertMaterial)&&("map"===o?(e.map=a,e.color&&e.color.setScalar(l)):"normalMap"===o&&void 0!==e.normalMap&&(e.normalMap=a,e.normalScale&&e.normalScale.set(n,-n)),e.needsUpdate=!0)})})}function s(e,a,t){var r;a&&e.model&&(null==(r=e.model.userData.materials)||r.forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(e.envMap=a,e.envMapIntensity=t,e.needsUpdate=!0)}))}function initialize(e,a){const t=n(a),r=e.canvas?e.canvas.width:e.drawingBufferWidth,o=e.canvas?e.canvas.height:e.drawingBufferHeight;if(0===r||0===o)return;t.scene=new THREE.Scene,t.camera=new THREE.PerspectiveCamera(35,r/o,.1,100),t.camera.position.set(0,0,5),t.renderer=new THREE.WebGLRenderer({canvas:e.canvas,context:e,alpha:!0,preserveDrawingBuffer:!1,premultipliedAlpha:!0,logarithmicDepthBuffer:!0,antialias:"high"===a.quality}),t.renderer.setClearColor(0,0),t.renderer.outputColorSpace=THREE.SRGBColorSpace,function(e,a){e.renderer&&(e.renderer.toneMapping=a?THREE.ACESFilmicToneMapping:THREE.NoToneMapping,e.renderer.toneMappingExposure=a?1.5:1,e.renderer.physicallyCorrectLights=a)}(t,"high"===a.quality),t.renderer.setPixelRatio(1),t.renderer.setSize(r,o,!1);const l=a.getProp("ambientLightColor"),i=a.getProp("ambientLightIntensity"),s=a.getProp("lightColor"),m=a.getProp("lightIntensity"),p=a.getProp("fillLightColor"),c=a.getProp("fillLightIntensity"),d=a.getProp("lightPosition");t.ambientLight=new THREE.AmbientLight(l||"#777777",2*(i??.75)),t.scene.add(t.ambientLight),t.directionalLight=new THREE.DirectionalLight(s||"#777777",5*(m??.2)*2),t.scene.add(t.directionalLight),t.fillLight=new THREE.DirectionalLight(p||"#777777",5*(c??.2)*2),t.scene.add(t.fillLight);const u=10*(d.x-.5),g=10*(d.y-.5),M=10*(d.z-.5);t.directionalLight&&t.directionalLight.position.set(u,-g,M),t.fillLight&&t.fillLight.position.set(.8*-u,.8*g,.8*-M)}function loadModel(t){const o=n(t);t.local.modelLoaded=!1,t.local.modelLoading=!1;const m=t.modelUrl.toLowerCase(),p=m.startsWith("data:image/svg+xml");if(m.split("?")[0].endsWith(".svg")||p){const e=e=>{var a,n;const m=e.paths,p=function(e,a,t){const r=new THREE.Group;for(let o=0;o<e.length;o++){const n=e[o],l=n.userData.style.fill;if(void 0!==l&&"none"!==l){const e=new THREE.MeshStandardMaterial({color:(new THREE.Color).setStyle(l),metalness:t.getProp("materialMetalness")??.5,roughness:t.getProp("materialRoughness")??.5,side:THREE.DoubleSide}),o=SVGLoader.createShapes(n);for(let t=0;t<o.length;t++){const n=o[t],l=new THREE.ExtrudeGeometry(n,a),i=l.attributes.position,s=l.attributes.uv;l.computeBoundingBox();const m=l.boundingBox.min,p=l.boundingBox.max,c=p.x-m.x,d=p.y-m.y,u=(e,a,t)=>{for(let r=e;r<e+a;r++){let e=r;if(l.index&&(e=l.index.getX(r)),t){const a=s.getX(e),t=s.getY(e),r=1/Math.max(c,d);s.setXY(e,a*r,t*r)}else{const a=i.getX(e),t=i.getY(e);s.setXY(e,(a-m.x)/c,(t-m.y)/d)}}};l.groups&&l.groups.length>0?l.groups.forEach(e=>{u(e.start,e.count,1===e.materialIndex)}):u(0,l.index?l.index.count:i.count,!1),s.needsUpdate=!0;const g=new THREE.Mesh(l,e);g.scale.set(1,-1,1),r.add(g)}}}return r}(m,{depth:t.getProp("extrudeDepth")??10,bevelEnabled:t.getProp("bevelEnabled")??!1,bevelThickness:t.getProp("bevelThickness")??1,bevelSize:t.getProp("bevelSize")??1,bevelSegments:t.getProp("bevelSegments")??2},t);o.model=p,o.model.userData.isSVG=!0,o.model.userData.svgPaths=m;const c=(new THREE.Box3).setFromObject(o.model),d=c.getCenter(new THREE.Vector3);o.model.position.copy(d).multiplyScalar(-1);const u=c.getSize(new THREE.Vector3),g=Math.max(u.x,u.y,u.z),M=g>0?1/g:1,h=new THREE.Group;h.add(o.model),o.model=h,o.model.userData.baseScale=M,o.model.userData.isSVGWrapper=!0,o.model.userData.materials=[],o.model.userData.textureMaterials=[],o.model.userData.meshes=[],o.model.traverse(e=>{e.isMesh&&(o.model.userData.meshes.push(e),o.model.userData.materials.push(e.material),o.model.userData.textureMaterials.push(e.material),e.material.userData||(e.material.userData={}),e.material.userData.originalMap=null,e.material.userData.originalNormalMap=null)}),t.renderNormals&&o.model.userData.meshes&&o.model.userData.meshes.forEach(e=>{e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=r)}),(null==(a=t.colorMapUrl)?void 0:a.trim())&&!t.renderNormals&&l(t.colorMapUrl,!1).then(e=>{const a=Math.max(.001,t.getProp("colorMapScale")??1),r=t.getProp("colorMapIntensity")??1;i(o,e,a,t.getProp("colorMapPosition"),"map",1,r),o.customColorMap=e}),(null==(n=t.normalMapUrl)?void 0:n.trim())&&!t.renderNormals&&l(t.normalMapUrl,!1,!0).then(e=>{const a=Math.max(.001,t.getProp("normalMapScale")??1);i(o,e,a,t.getProp("normalMapPosition"),"normalMap",t.getProp("normalMapIntensity")),o.customNormalMap=e}),o.customEnvMap&&t.environmentMapIntensity>0&&s(o,o.customEnvMap,t.environmentMapIntensity),o.scene.add(o.model),t.handleModelLoaded()};if(p)try{const r=t.modelUrl.split(",")[1],o=decodeURIComponent(escape(atob(r)));e(a.parse(o))}catch(c){console.error("An error occurred while parsing the SVG data URL:",c),t.local.modelLoading=!1}else a.load(t.modelUrl,e,e=>{e.total>0&&console.log(e.loaded/e.total*100+"% loaded")},e=>{console.error("An error occurred while loading the SVG:",e),t.local.modelLoading=!1})}else e.load(t.modelUrl,e=>{var a;o.model=e.scene;const n=(new THREE.Box3).setFromObject(o.model),m=n.getCenter(new THREE.Vector3);o.model.position.copy(m).multiplyScalar(-1);const p=n.getSize(new THREE.Vector3),c=Math.max(p.x,p.y,p.z),d=c>0?1/c:1,u=new THREE.Group;u.add(o.model),o.model=u,o.model.userData.baseScale=d,o.model.userData.materials=[],o.model.traverse(e=>{if(e.isMesh){const a=Array.isArray(e.material)?e.material:[e.material],n=t.getProp("materialMetalness"),l=t.getProp("materialRoughness");a.forEach((a,t)=>{var r;if((a.isMeshPhongMaterial||a.isMeshLambertMaterial)&&!(null==(r=a.userData)?void 0:r.converted)){const r=function(e){const a=new THREE.MeshStandardMaterial;return a.color.copy(e.color),a.map=e.map,a.normalMap=e.normalMap,a.emissiveMap=e.emissiveMap,a.aoMap=e.aoMap,a.emissive.copy(e.emissive||new THREE.Color(0,0,0)),a.opacity=e.opacity??1,a.transparent=e.transparent??!1,a.side=e.side??THREE.FrontSide,e.userData||(e.userData={}),a.userData=e.userData,a.userData.converted=!0,a}(a);Array.isArray(e.material)?e.material[t]=r:e.material=r,a=r}o.model.userData.materials.push(a),void 0!==a.metalness&&(a.metalnessMap&&(a.metalnessMap=null,a.needsUpdate=!0),a.metalness=n??a.metalness),void 0!==a.roughness&&(a.roughnessMap&&(a.roughnessMap=null,a.needsUpdate=!0),a.roughness=l??a.roughness),(a.isMeshStandardMaterial||a.isMeshPhysicalMaterial)&&(a.envMapIntensity=a.envMapIntensity??1)}),t.renderNormals&&(e.material=r)}}),t.colorMapUrl&&!t.renderNormals&&(o.model.traverse(e=>{e.isMesh&&(Array.isArray(e.material)?e.material:[e.material]).forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhongMaterial||e.isMeshLambertMaterial)&&(e.map=null,e.needsUpdate=!0)})}),l(t.colorMapUrl,!1).then(e=>{o.customColorMap=e;const a=t.getProp("colorMapIntensity")??1;i(o,e,Math.max(.001,t.getProp("colorMapScale")),t.getProp("colorMapPosition"),"map",1,a)})),t.normalMapUrl&&!t.renderNormals&&l(t.normalMapUrl,!1,!0).then(e=>{o.customNormalMap=e,i(o,e,Math.max(.001,t.getProp("normalMapScale")),t.getProp("normalMapPosition"),"normalMap",t.getProp("normalMapIntensity"))});const g=t.getProp("environmentMapIntensity");g>0&&(null==(a=t.environmentMapUrl)?void 0:a.trim())&&l(t.environmentMapUrl,!0).then(e=>{o.customEnvMap=e,s(o,o.customEnvMap,g)}),o.scene.add(o.model),t.handleModelLoaded()},void 0,e=>{console.error("An error occurred while loading the model:",e)});t.local.modelLoading=!0}function isLoading(e){return e.local.modelLoading&&!e.local.modelLoaded}function draw(e,a,t){var r,o,l,i,m;const p=n(t);if(!t.local.modelLoaded)return;if(!p.renderer||!p.renderer.getContext()||p.renderer.getContext().isContextLost())return console.warn("Three.js renderer context lost, reinitializing..."),void(t.local.initialized=!1);const c=e.canvas?e.canvas.width:e.drawingBufferWidth,d=e.canvas?e.canvas.height:e.drawingBufferHeight;if(0===c||0===d)return;const u=t.getProp("environmentMapIntensity");if(u>0&&!(null==(r=t.environmentMapUrl)?void 0:r.trim())){const e=t.local.envTexture,a=(null==(o=p.model)?void 0:o.userData.lastEnvMapIntensity)!==u;!e||!a&&p.envMap||function(e,a,t,r,o,n){var l,i,m;if(t&&a)if(e.envMap)e.model.userData.lastEnvMapIntensity!==n&&(null==(m=e.model.userData.materials)||m.forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(e.envMapIntensity=n)}),e.model.userData.lastEnvMapIntensity=n);else{e.envMap=new THREE.Texture,e.envMap.mapping=THREE.EquirectangularReflectionMapping,e.envMap.colorSpace=THREE.SRGBColorSpace,e.envMap.minFilter=THREE.LinearFilter,e.envMap.magFilter=THREE.LinearFilter,e.envMap.generateMipmaps=!1,e.envMap.flipY=!1,e.envMap.image={width:r,height:o};const a=e.renderer.properties.get(e.envMap);a.__webglTexture=t,a.__webglInit=!0;const l=e.renderer.info.memory;l&&l.textures++,s(e,e.envMap,n)}else null==(i=null==(l=e.model)?void 0:l.userData.materials)||i.forEach(e=>{e.envMap&&(e.envMap=null,e.needsUpdate=!0)})}(p,e.gl,e.webglTexture,e.width,e.height,u)}let g=0,M=0,h=0,v=0,y=0,f=0;const P=t.getProp("trackMouse"),x=t.getProp("rotationTracking"),L=t.getProp("lightTracking");if(0!=P||0!=x||0!=L){const e=t.local.mouse||{x:.5,y:.5},a=e.x-.5,r=e.y-.5;0!=P&&(g=a*P,M=-r*P),0!=x&&(h=-r*x,v=-a*x),0!=L&&(y=a*L,f=-r*L)}p.camera.userData.dim||(p.camera.userData.dim={}),p.camera.userData.dim.w===c&&p.camera.userData.dim.h===d||(p.camera.aspect=c/d,p.camera.updateProjectionMatrix(),p.renderer.setSize(c,d,!1),p.camera.userData.dim={w:c,h:d});const S=p.scene.userData.lp=p.scene.userData.lp||{},D=t.getProp("ambientLightIntensity"),w=t.getProp("ambientLightColor"),b=t.getProp("lightIntensity"),C=t.getProp("lightColor"),E=t.getProp("fillLightIntensity"),I=t.getProp("fillLightColor");!p.ambientLight||S.ai===D&&S.ac===w||(S.ai!==D&&(p.ambientLight.intensity=2*(D??.75)),S.ac!==w&&p.ambientLight.color.set(w||"#777777"),S.ai=D,S.ac=w),!p.directionalLight||S.li===b&&S.lc===C||(p.directionalLight.intensity=5*(b??.2)*2,p.directionalLight.color.set(C||"#777777"),S.li=b,S.lc=C),!p.fillLight||S.fli===E&&S.flc===I||(p.fillLight.intensity=5*(E??.2)*2,p.fillLight.color.set(I||"#777777"),S.fli=E,S.flc=I);const z=t.getProp("lightPosition"),U=0!=L;if(p.directionalLight&&z&&(U||S.lx!==z.x||S.ly!==z.y||S.lz!==z.z)){const e=10*(z.x+y-.5),a=10*(z.y+f-.5),t=10*(z.z-.5);p.directionalLight.position.set(e,-a,t),p.fillLight.position.set(.8*-e,.8*a,.8*-t),U||(S.lx=z.x,S.ly=z.y,S.lz=z.z)}if(p.model){const e=p.model.userData.mp=p.model.userData.mp||{},r=t.getProp("materialMetalness"),o=t.getProp("materialRoughness");e.mm===r&&e.mr===o||(null==(l=p.model.userData.materials)||l.forEach(a=>{e.mm!==r&&void 0!==a.metalness&&(a.metalnessMap&&(a.metalnessMap=null,a.needsUpdate=!0),a.metalness=r),e.mr!==o&&void 0!==a.roughness&&(a.roughnessMap&&(a.roughnessMap=null,a.needsUpdate=!0),a.roughness=o)}),e.mm=r,e.mr=o);const n=t.getProp("colorMapScale"),c=t.getProp("colorMapPosition"),d=t.getProp("colorMapIntensity");if(p.customColorMap&&!t.renderNormals&&(e.cms!==n||e.cmpx!==(null==c?void 0:c.x)||e.cmpy!==(null==c?void 0:c.y)||e.cmi!==d)){const a=Math.max(.001,n);p.customColorMap.repeat.setScalar(a);const t=-(a-1)/2,r=((null==c?void 0:c.x)??.5)-.5,o=((null==c?void 0:c.y)??.5)-.5;p.customColorMap.offset.set(t+r,t+o);const l=d??1;null==(i=p.model.userData.materials)||i.forEach(e=>{(e.isMeshStandardMaterial||e.isMeshPhongMaterial||e.isMeshLambertMaterial)&&(e.color&&e.color.setScalar(l),e.needsUpdate=!0)}),e.cms=n,e.cmpx=null==c?void 0:c.x,e.cmpy=null==c?void 0:c.y,e.cmi=d}const y=t.getProp("normalMapScale"),f=t.getProp("normalMapPosition"),P=t.getProp("normalMapIntensity");if(p.customNormalMap&&!t.renderNormals&&(e.nms!==y||e.nmpx!==(null==f?void 0:f.x)||e.nmpy!==(null==f?void 0:f.y)||e.nmi!==P)){const a=Math.max(.001,y);p.customNormalMap.repeat.setScalar(a);const t=-(a-1)/2,r=((null==f?void 0:f.x)??.5)-.5,o=((null==f?void 0:f.y)??.5)-.5;p.customNormalMap.offset.set(t+r,t+o);const n=P??1;null==(m=p.model.userData.materials)||m.forEach(e=>{void 0!==e.normalMap&&e.normalScale&&(e.normalScale.set(n,-n),e.needsUpdate=!0)}),e.nms=y,e.nmpx=null==f?void 0:f.x,e.nmpy=null==f?void 0:f.y,e.nmi=P}p.customEnvMap&&e.emi!==u&&(s(p,p.customEnvMap,u),e.emi=u);const x=p.model.userData.baseScale||1,L=t.getProp("pos"),S=t.getProp("scale");if(e.s!==S){const a=10*S*x;p.model.scale.set(a,a,a),e.s=S}const D=0!==g||0!==M;if(L&&(D||e.px!==L.x||e.py!==L.y||e.pz!==L.z)){const a=8*(L.x-.5+g),t=8*(L.y-.5+M),r=8*(L.z-.5);p.model.position.set(a,-t,r),D||(e.px=L.x,e.py=L.y,e.pz=L.z)}const w=t.getProp("modelRotation"),b=t.getProp("speed"),C=t.getProp("animationAxis"),E=0!==h||0!==v,I=b>0&&t.animating;if(w&&(E||I||e.rx!==w.x||e.ry!==w.y||e.rz!==w.z)){let t=(w.y-.5+h)*Math.PI*2+Math.PI,r=p.model.userData.isSVGWrapper?Math.PI:0,o=(w.x-.5+v)*Math.PI*2+r,n=(w.z-.5)*Math.PI*2;if(I){const e=b*a*.001;C.x>0&&(t+=e*C.x),C.y>0&&(o+=e*C.y),C.z>0&&(n+=e*C.z)}p.model.rotation.set(t,o,n),E||I||(e.rx=w.x,e.ry=w.y,e.rz=w.z)}}p.renderer.render(p.scene,p.camera),p.renderer.resetState&&p.renderer.resetState()}function dispose(e){const a=n(e);a.customColorMap&&(a.customColorMap.dispose(),a.customColorMap=null),a.customNormalMap&&(a.customNormalMap.dispose(),a.customNormalMap=null),a.customEnvMap&&(a.customEnvMap.dispose(),a.customEnvMap=null),a.envMap&&(a.envMap.dispose(),a.envMap=null),a.model&&(a.model.traverse(e=>{e.isMesh&&(e.geometry&&e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material&&e.material.dispose())}),a.scene&&a.scene.remove(a.model),a.model=null),a.renderer&&(a.renderer.dispose(),a.renderer=null),a.scene=null,a.camera=null,a.ambientLight=null,a.directionalLight=null,a.fillLight=null,o.delete(e)}export{dispose,draw,initialize,isLoading,loadModel};
